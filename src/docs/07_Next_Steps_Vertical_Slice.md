# 7. الخطوة التالية: شريحة عمودية قابلة للعب (Vertical Slice Hardening)

---

## 1. الهدف الرئيسي (The Goal)

بناءً على التقدم الممتاز في تطوير الميزات، تنتقل الأولوية الآن من **إضافة ميزات جديدة** إلى **ترسيخ وتقوية** ما تم بناؤه.

الهدف لهذا السبرنت هو: **إنتاج شريحة عمودية (Vertical Slice) من اللعبة قابلة للعب بشكل يومي لمدة 10-15 دقيقة، تتميز بالاستقرار الكامل، خالية من الأعطال والثغرات، مع ضمان عدم فقدان أي تقدم للاعب، وتوفير آليات لقياس سلوك اللاعبين بشكل واضح.**

هذه الخطوة حاسمة لتحويل المشروع من نموذج أولي غني بالميزات إلى أساس متين يمكن البناء عليه بثقة.

---

## 2. خطة التنفيذ (Implementation Plan)

سيتم التركيز على خمسة محاور رئيسية:

### 2.1. تقوية نظام الحالة والحفظ (State & Save/Load Hardening)

-   **المهام (Tasks):**
    -   **إصدار الحالة (State Versioning):** إضافة رقم إصدار إلى `PlayerState` للسماح بعمليات ترحيل (Migration) بسيطة للبيانات في المستقبل عند تغيير هيكل الحالة.
    -   **توحيد نقاط الحفظ:**
        -   تطبيق نظام حفظ تلقائي "مؤجل" (Debounced) لتجنب الكتابة المفرطة على قاعدة البيانات.
        -   تطبيق "حفظ فوري" للأحداث الحرجة (مثل الشراء، البيع، الترقية) لضمان عدم فقدان البيانات.
    -   **معالجة التعارضات:** وضع استراتيجية واضحة للتعامل مع البيانات عند فتح اللعبة على جهازين (مثل `Last-write wins` أو الاعتماد على `server timestamp`).

-   **معايير القبول (Acceptance Criteria):**
    -   لا يتم فقدان أي تقدم عند تحديث الصفحة، انقطاع الاتصال، أو العودة للعبة.
    -   لا يمكن تكرار المكافآت أو ازدواجية الإنتاج بسبب إعادة التحميل السريع.

### 2.2. أمن Firestore ولوحة التحكم (Security Hardening - High Priority)

-   **المهام (Tasks):**
    -   **مراجعة شاملة لقواعد أمان Firestore:**
        -   التأكد من أن اللاعب لا يستطيع تعديل إلا مستنداته الخاصة وحقول محددة داخلها.
        -   نقل العمليات الحساسة (منح عملات/XP) لتتم عبر مسار محمي بدور `admin`، ويفضل عبر Cloud Functions في المستقبل.
    -   **تدقيق نقاط الاقتصاد:** التحقق من أن جميع عمليات البيع والشراء والمكافآت يتم التحقق من صحتها من جانب الخادم (Server-validated) قدر الإمكان لمنع التلاعب من جانب العميل.
    -   **تحديد معدل الطلبات (Rate Limiting):** وضع حدود على استدعاءات Gemini API لمنع الاستنزاف أو الاستخدام المفرط.

-   **معايير القبول (Acceptance Criteria):**
    -   من المستحيل على اللاعب تزوير العملات أو نقاط الخبرة من خلال أدوات المتصفح.
    -   جميع عمليات المسؤولين يتم تسجيلها (Audit Log) في Firestore لتتبع التغييرات.

### 2.3. المراقبة والتشخيص (Observability)

-   **المهام (Tasks):**
    -   **نظام تقارير الأخطاء:** إضافة نظام بسيط لتبليغ الأخطاء (على الأقل تسجيل أخطاء العميل في مجموعة خاصة بـ Firestore).
    -   **تحليلات الأحداث الأساسية (Event Analytics):** تتبع الأحداث الرئيسية لسلوك اللاعب مثل:
        -   `session_start`, `tutorial_complete`, `first_plant`, `first_harvest`, `task_completed`.
    -   **لوحة مراقبة بسيطة:** إضافة واجهة في لوحة التحكم لعرض آخر الأخطاء والأحداث المسجلة.

-   **معايير القبول (Acceptance Criteria):**
    -   أي خطأ فادح (Crash) يتم تسجيله تلقائيًا مع السياق الكامل (userId, timestamp, system).

### 2.4. توازن الاقتصاد والسرعات (Balancing Pass)

-   **المهام (Tasks):**
    -   **تحديد خطوط الأساس (Baselines):**
        -   حساب متوسط الدخل لكل دقيقة للاعب الجديد.
        -   ضبط أوقات نمو المحاصيل وتكاليفها.
        -   موازنة تكلفة توسيع الأراضي مقابل العائد المتوقع منها.
    -   **ضبط السوق الديناميكي:**
        -   التأكد من أن التقلبات العشوائية لا تدمر اقتصاد اللاعب الجديد.
        -   وضع حدود قصوى ودنيا لتأثير "أحداث السوق".

-   **معايير القبول (Acceptance Criteria):**
    -   اللاعب الجديد يجب أن يكون قادرًا على الوصول إلى أول ترقية أو مبنى مفيد خلال 10-15 دقيقة من اللعب دون شعور بالملل أو الصعوبة المفرطة.

### 2.5. تجربة أول 10 دقائق (Onboarding / First 10 Mins)

-   **المهام (Tasks):**
    -   **مسار تعليمي (Tutorial):** بناء مسار إرشادي من 6-10 خطوات يغطي الحلقة الأساسية (زرع ← حصاد ← بيع ← شراء ← توسيع ← إنتاج).
    -   **تلميحات واجهة المستخدم:** إضافة تلميحات بصرية على الكائنات القابلة للتفاعل لتوجيه اللاعب.
    -   **مكافأة إكمال المسار:** تقديم مكافأة صغيرة بعد إكمال المسار التعليمي لخلق "حلقة يومية" إيجابية.

-   **معايير القبول (Acceptance Criteria):**
    -   اللاعب الجديد يفهم تمامًا حلقة اللعب الأساسية دون الحاجة لقراءة وثائق خارجية.
