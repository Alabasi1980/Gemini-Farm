# 99. الهيكلية البرمجية (Technical Architecture)

---

هذا المستند هو المرجع التقني الأساسي للمطورين. يشرح القرارات الهندسية الرئيسية، هيكل المشروع، والأنماط المتبعة لضمان كتابة كود نظيف، قابل للصيانة، وعالي الأداء.

## 1. هيكل المشروع (Project Structure)

تعتمد اللعبة على **بنية قائمة على الأنظمة (System-Based Architecture)**. الهدف هو تنظيم الكود حول "ميزات" اللعبة بدلاً من تنظيمها حسب "نوع" الملف.

```
src
├── systems/
│   ├── farm/         // كل ما يتعلق بالمزرعة والزراعة
│   ├── player/       // كل ما يتعلق بحالة اللاعب (HUD، XP)
│   ├── production/   // كل ما يتعلق بالمصانع والإنتاج
│   └── ...           // أنظمة أخرى
│
├── shared/
│   ├── services/     // خدمات مشتركة بين الأنظمة
│   ├── types/        // تعريفات الأنواع (TypeScript)
│   └── pipes/        // Pipes مشتركة
│
└── app.component.ts  // المكون الجذري
```

-   **مجلد `systems`:** هو قلب التطبيق. كل مجلد فرعي يمثل نظامًا مستقلاً وظيفيًا (مثل `farm`, `shop`, `tasks`). يجب أن يحتوي كل نظام على مكوناته وخدماته الخاصة.
-   **مجلد `shared`:** يحتوي على الكود الذي يتم استخدامه من قبل نظامين أو أكثر. القاعدة الأساسية هي: لا تضع شيئًا في `shared` إلا إذا كان هناك حاجة حقيقية ومثبتة لإعادة استخدامه.
-   **التواصل بين الأنظمة:** الطريقة الوحيدة للتواصل بين نظامين هي من خلال حقن (injecting) خدمة من نظام في خدمة أخرى. يجب تجنب الاعتماديات المباشرة بين المكونات من أنظمة مختلفة.

---

## 2. إدارة الحالة (State Management)

تستخدم اللعبة **Angular Signals** بشكل حصري لإدارة الحالة. هذا يضمن واجهة مستخدم سريعة الاستجابة ويجعل تتبع تدفق البيانات سهلاً.

-   **`signal()`:** يستخدم لتخزين الحالة الأساسية والقابلة للتغيير.
    -   **مثال:** `gameStateService.state` هو `signal` يحتوي على كائن `PlayerState` بأكمله. أي تغيير في عملات اللاعب أو مخزونه يجب أن يتم من خلال تحديث هذا الـ signal.

-   **`computed()`:** يستخدم لاشتقاق بيانات من `signal` أو أكثر. هذه هي الطريقة المفضلة لحساب القيم التي تعتمد على الحالة.
    -   **مثال:** `gameStateService.currentStorage` هو `computed` signal يقوم بحساب إجمالي العناصر في المخزون كلما تغير `state().inventory`. لا يتم تخزين هذه القيمة بشكل منفصل، بل يتم حسابها عند الحاجة فقط.

-   **`effect()`:** يستخدم لتنفيذ الآثار الجانبية (Side Effects) استجابةً لتغير `signal`. يجب استخدامه بحذر، ويفضل أن يكون داخل الخدمات.
    -   **مثال:** يوجد `effect` في `GameStateService` يقوم تلقائيًا بحفظ بيانات اللاعب في Firestore كلما تغير `state()`.

-   **مبدأ "مصدر الحقيقة الواحد" (Single Source of Truth):**
    -   يجب أن تكون الخدمات (Services) هي المسؤولة عن امتلاك وإدارة الحالة المشتركة (مثل `GameStateService`, `GridService`).
    -   يجب أن تكون المكونات (Components) مسؤولة فقط عن عرض هذه الحالة والتفاعل معها، وليس تخزين نسختها الخاصة منها.

---

## 3. التكامل مع Firebase

يتم استخدام Firebase كخلفية للعبة (Backend) لإدارة البيانات والمصادقة.

-   **Firestore (قاعدة البيانات):**
    -   **بنية المجموعات (Collections Structure):**
        -   `users/{uid}`: لتخزين بيانات الحساب (email, role).
        -   `players/{uid}`: لتخزين بيانات اللعبة التقدمية (`playerState`).
        -   `content/live/{collection}`: لتخزين بيانات اللعبة الثابتة (crops, items, recipes). استخدام `live` يسمح بإمكانية إضافة بيئات أخرى مثل `staging` في المستقبل.
-   **Authentication (المصادقة):**
    -   يتم استخدام مصادقة البريد الإلكتروني وكلمة المرور.
    -   `AuthenticationService` يلف (wraps) Firebase Auth SDK ويوفر signals (`authState`, `user`, `userRole`) لبقية التطبيق للاستماع إليها.

---

## 4. استراتيجية التصميم (Styling Strategy)

-   **Tailwind CSS:** هو الإطار الأساسي لجميع التصاميم. يوفر سرعة في التطوير وتناسقًا في المظهر.
-   **CSS مخصص مركزي:**
    -   لا يتم استخدام ملفات CSS خاصة بالمكونات (`styleUrls`).
    -   جميع ملفات الـ CSS المخصصة موجودة في مجلد `src/styles`.
    -   يتم تنظيم هذه الملفات في مجلدات فرعية تعكس بنية `systems` (مثل `src/styles/farm/`).
    -   يتم استيراد جميع هذه الملفات في ملف `src/styles/styles.css` الرئيسي.
    -   **السبب:** هذه الطريقة تسهل إدارة السمات (Themes) الشاملة (مثل الفصول والطقس) وتضمن عدم وجود تضارب في الأنماط.

---

## 5. تعبئة البيانات الأولية (Content Seeding)

-   **`ContentSeedingService`:** هذه الخدمة مسؤولة عن التأكد من أن قاعدة بيانات Firestore تحتوي على البيانات الأساسية اللازمة لتشغيل اللعبة (المحاصيل، المباني، إلخ).
-   **آلية العمل:** عند بدء تشغيل التطبيق، تتحقق الخدمة مما إذا كانت مجموعة `crops` فارغة. إذا كانت كذلك، فإنها تفترض أن قاعدة البيانات جديدة وتقوم بملء جميع مجموعات المحتوى بالبيانات الافتراضية من ملف `default-content.ts`.
-   **الأهمية:** هذا يضمن أن أي مطور جديد يمكنه تشغيل المشروع لأول مرة دون الحاجة إلى إعداد قاعدة البيانات يدويًا.
