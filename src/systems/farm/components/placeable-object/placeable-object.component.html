<div class="relative w-full h-full"
     [class.cursor-grab]="!isAnimalBuilding() && !isFactory()"
     [class.active:cursor-grabbing]="!isAnimalBuilding() && !isFactory()">

    <!-- Drag Visual Feedback (Stays in transformed space) -->
    <div class="absolute inset-0 rounded-lg transition-colors"
         [class]="{
            'bg-green-500/40': isBeingDragged() && displayState().isValid,
            'bg-red-500/50': isBeingDragged() && !displayState().isValid
         }">
    </div>

    <!-- Main content wrapper to un-transform elements -->
    <div class="un-transform w-full h-full transition-transform duration-100" [class.scale-105]="isBeingDragged()">
        <div class="relative w-full h-full flex items-center justify-center" [class.cursor-grab]="true" [class.active:cursor-grabbing]="true" (mousedown)="onMouseDown($event)">
            @if (item(); as itemData) {
                <span class="select-none drop-shadow-lg" 
                    [style.font-size.rem]="(itemData.width + itemData.height) * 1.5"
                    [class.opacity-75]="isBeingDragged()">
                    {{ itemData.asset }}
                </span>
            }

            <!-- Animal Production UI -->
            @if (animalProductionInfo(); as info) {
                <div class="absolute -top-8 left-1/2 -translate-x-1/2 w-32 h-10 flex items-center justify-center">
                    @if (info.isReady) {
                        <button (click)="handleInteraction($event, 'collect')" class="interaction-button h-10 px-4 bg-yellow-500 text-black font-bold rounded-full shadow-lg flex items-center space-x-2 animate-bounce hover:bg-yellow-400 transition-colors">
                            <span>Collect</span>
                            <span class="text-2xl">{{ animalService.getProduct(item()?.producesProductId!)?.asset }}</span>
                        </button>
                        <div class="absolute -top-2 -right-2 text-2xl animate-ping">âœ¨</div>
                    } @else {
                        <div class="w-full h-2 bg-gray-900/50 rounded-full overflow-hidden">
                            <div class="h-full bg-green-400" [style.width.%]="info.progress"></div>
                        </div>
                    }
                </div>
            }

            <!-- Factory Production UI -->
            @if (factoryInfo(); as info) {
                <div class="absolute -top-8 left-1/2 -translate-x-1/2 h-10 flex items-center justify-center space-x-2">
                    @if(info.isReady) {
                        <button (click)="handleInteraction($event, 'collect-factory')" class="interaction-button h-10 px-4 bg-yellow-500 text-black font-bold rounded-full shadow-lg flex items-center space-x-2 animate-bounce hover:bg-yellow-400 transition-colors">
                            <span>Collect</span>
                        </button>
                    } @else if (info.isProducing) {
                        <div class="w-32 h-2 bg-gray-900/50 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-400" [style.width.%]="info.progress"></div>
                        </div>
                    } @else {
                        <button (click)="handleInteraction($event, 'produce')" class="interaction-button h-10 px-4 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-500 transition-colors">
                            Produce
                        </button>
                    }
                </div>
                <div class="absolute -bottom-2 right-0 bg-gray-900/70 text-white text-xs font-bold px-2 py-0.5 rounded-full">
                    {{ info.queueCount }} / {{ info.queueSize }}
                </div>
            }
        </div>
    </div>
</div>